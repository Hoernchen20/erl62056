-module(erl62056_parser_tests).
-include_lib("eunit/include/eunit.hrl").

%%-------------------------------------------------------------------------------------------------
%% Tests descriptions
%%-------------------------------------------------------------------------------------------------
% TODO encode_test_()

decode_test_() ->
    [
        {"Calculate block check character", fun calculate_block_check_character/0},
        {"Check block check character", fun check_block_check_character/0},
        {"Decode a single data set", fun decode_single_data_set/0},
        {"Decode multiple data sets", fun decode_multiple_data_sets/0},
        {"Decode a block of data sets", fun decode_data_block/0},
        {"Decode identification message", fun decode_identification_message/0},
        {"Decode data message", fun decode_data_message/0}
    ].

%%-------------------------------------------------------------------------------------------------
%% Setup functions
%%-------------------------------------------------------------------------------------------------

%%-------------------------------------------------------------------------------------------------
%% Actual tests
%%-------------------------------------------------------------------------------------------------
calculate_block_check_character() ->
    Data1 = <<"Hello World!">>,
    Expect1 = 1,
    Result1 = erl62056_parser:calculate_bcc(Data1),
    ?assertEqual(Expect1, Result1),
    Data2 = <<"r8w09hgfnblg">>,
    Expect2 = 16#5a,
    Result2 = erl62056_parser:calculate_bcc(Data2),
    ?assertEqual(Expect2, Result2),
    Data3 =
        <<16#31, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#32, 16#2e, 16#37, 16#39, 16#39, 16#2a, 16#6b,
            16#57, 16#29, 16#0d, 16#0a, 16#32, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e,
            16#30, 16#30, 16#30, 16#2a, 16#6b, 16#57, 16#29, 16#0d, 16#0a, 16#33, 16#32, 16#2e,
            16#37, 16#2e, 16#30, 16#28, 16#32, 16#33, 16#32, 16#2e, 16#35, 16#32, 16#2a, 16#56,
            16#29, 16#0d, 16#0a, 16#35, 16#32, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#32, 16#33,
            16#32, 16#2e, 16#31, 16#34, 16#2a, 16#56, 16#29, 16#0d, 16#0a, 16#37, 16#32, 16#2e,
            16#37, 16#2e, 16#30, 16#28, 16#32, 16#33, 16#32, 16#2e, 16#39, 16#35, 16#2a, 16#56,
            16#29, 16#0d, 16#0a, 16#33, 16#31, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#36, 16#2e,
            16#31, 16#31, 16#2a, 16#41, 16#29, 16#0d, 16#0a, 16#35, 16#31, 16#2e, 16#37, 16#2e,
            16#30, 16#28, 16#36, 16#2e, 16#38, 16#32, 16#2a, 16#41, 16#29, 16#0d, 16#0a, 16#37,
            16#31, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#36, 16#2e, 16#30, 16#32, 16#2a, 16#41,
            16#29, 16#0d, 16#0a, 16#32, 16#31, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e,
            16#38, 16#39, 16#35, 16#2a, 16#6b, 16#57, 16#29, 16#0d, 16#0a, 16#34, 16#31, 16#2e,
            16#37, 16#2e, 16#30, 16#28, 16#31, 16#2e, 16#32, 16#31, 16#32, 16#2a, 16#6b, 16#57,
            16#29, 16#0d, 16#0a, 16#36, 16#31, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e,
            16#36, 16#39, 16#31, 16#2a, 16#6b, 16#57, 16#29, 16#0d, 16#0a, 16#32, 16#32, 16#2e,
            16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e, 16#30, 16#30, 16#30, 16#2a, 16#6b, 16#57,
            16#29, 16#0d, 16#0a, 16#34, 16#32, 16#2e, 16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e,
            16#30, 16#30, 16#30, 16#2a, 16#6b, 16#57, 16#29, 16#0d, 16#0a, 16#36, 16#32, 16#2e,
            16#37, 16#2e, 16#30, 16#28, 16#30, 16#2e, 16#30, 16#30, 16#30, 16#2a, 16#6b, 16#57,
            16#29, 16#0d, 16#0a, 16#21, 16#0d, 16#0a, 16#03>>,
    Expect3 = 16#3d,
    Result3 = erl62056_parser:calculate_bcc(Data3),
    ?assertEqual(Expect3, Result3).

check_block_check_character() ->
    Data1 = <<"r8w09hgfnblg">>,
    Expect1 = error,
    Result1 = erl62056_parser:check_bcc(Data1, 16#5b),
    ?assertEqual(Expect1, Result1),
    Data2 = <<"r8w09hgfnblg">>,
    Expect2 = ok,
    Result2 = erl62056_parser:check_bcc(Data2, 16#5a),
    ?assertEqual(Expect2, Result2).

decode_single_data_set() ->
    Data1 = ["C.3.0(00110000)"],
    Expect1 = [{<<"C.3.0">>, <<"00110000">>, undefined}],
    Result1 = erl62056_parser:decode_data_set(Data1, []),
    ?assertEqual(Expect1, Result1),
    Data2 = ["1.7.0(0.004*kW)"],
    Expect2 = [{<<"1.7.0">>, <<"0.004">>, <<"kW">>}],
    Result2 = erl62056_parser:decode_data_set(Data2, []),
    ?assertEqual(Expect2, Result2).

decode_multiple_data_sets() ->
    Data1 = ["2.8.0(0017422.710*kWh)", "0.0.1(  1ELS0012345678)"],
    Expect1 = [
        {<<"2.8.0">>, <<"0017422.710">>, <<"kWh">>},
        {<<"0.0.1">>, <<"  1ELS0012345678">>, undefined}
    ],
    Result1 = erl62056_parser:decode_data_set(Data1, []),
    ?assertEqual(Expect1, Result1).

decode_data_block() ->
    Data1 =
        "C.3.0(00110000)\r\n1.7.0(0.004*kW)\r\n2.7.0(0.000*kW)\r\n32.7.0(233.7*V)\r\n52.7.0(233.4*V)\r\n72.7.0(233.5*V)\r\n31.7.0(0.000*A)\r\n51.7.0(0.082*A)\r\n71.7.0(0.000*A)\r\n3.7.0(0.000*kvar)\r\n4.7.0(0.032*kvar)\r\n9.7.0(0.032*kVA)\r\n10.7.0(0.000*kVA)\r\n0.0.1(  1ELS0012345678)\r\n0.9.1(063058)\r\n0.9.2(240904)\r\n2.8.0(0017422.710*kWh)\r\n",
    Expect1 = [
        {<<"C.3.0">>, <<"00110000">>, undefined},
        {<<"1.7.0">>, <<"0.004">>, <<"kW">>},
        {<<"2.7.0">>, <<"0.000">>, <<"kW">>},
        {<<"32.7.0">>, <<"233.7">>, <<"V">>},
        {<<"52.7.0">>, <<"233.4">>, <<"V">>},
        {<<"72.7.0">>, <<"233.5">>, <<"V">>},
        {<<"31.7.0">>, <<"0.000">>, <<"A">>},
        {<<"51.7.0">>, <<"0.082">>, <<"A">>},
        {<<"71.7.0">>, <<"0.000">>, <<"A">>},
        {<<"3.7.0">>, <<"0.000">>, <<"kvar">>},
        {<<"4.7.0">>, <<"0.032">>, <<"kvar">>},
        {<<"9.7.0">>, <<"0.032">>, <<"kVA">>},
        {<<"10.7.0">>, <<"0.000">>, <<"kVA">>},
        {<<"0.0.1">>, <<"  1ELS0012345678">>, undefined},
        {<<"0.9.1">>, <<"063058">>, undefined},
        {<<"0.9.2">>, <<"240904">>, undefined},
        {<<"2.8.0">>, <<"0017422.710">>, <<"kWh">>}
    ],
    Result1 = erl62056_parser:decode_data_block(Data1),
    ?assertEqual(Expect1, Result1).

decode_identification_message() ->
    Data1 = <<"/ELS5\\@V9.35         \r\n">>,
    Expect1 = {ok, {identification_message, <<"ELS">>, 9600, <<"\\@V9.35         ">>}, <<>>},
    Result1 = erl62056_parser:decode(Data1),
    ?assertEqual(Expect1, Result1).

decode_data_message() ->
    Data1 =
        <<16#02,
            "C.3.0(00110000)\r\n1.7.0(0.004*kW)\r\n2.7.0(0.000*kW)\r\n32.7.0(233.7*V)\r\n52.7.0(233.4*V)\r\n72.7.0(233.5*V)\r\n31.7.0(0.000*A)\r\n51.7.0(0.082*A)\r\n71.7.0(0.000*A)\r\n3.7.0(0.000*kvar)\r\n4.7.0(0.032*kvar)\r\n9.7.0(0.032*kVA)\r\n10.7.0(0.000*kVA)\r\n0.0.1(  1ELS0012345678)\r\n0.9.1(063058)\r\n0.9.2(240904)\r\n2.8.0(0017422.710*kWh)\r\n",
            16#21, 16#0d, 16#0a, 16#03, 16#7d>>,
    Expect1 =
        {ok,
            {data_message, [
                {<<"C.3.0">>, <<"00110000">>, undefined},
                {<<"1.7.0">>, <<"0.004">>, <<"kW">>},
                {<<"2.7.0">>, <<"0.000">>, <<"kW">>},
                {<<"32.7.0">>, <<"233.7">>, <<"V">>},
                {<<"52.7.0">>, <<"233.4">>, <<"V">>},
                {<<"72.7.0">>, <<"233.5">>, <<"V">>},
                {<<"31.7.0">>, <<"0.000">>, <<"A">>},
                {<<"51.7.0">>, <<"0.082">>, <<"A">>},
                {<<"71.7.0">>, <<"0.000">>, <<"A">>},
                {<<"3.7.0">>, <<"0.000">>, <<"kvar">>},
                {<<"4.7.0">>, <<"0.032">>, <<"kvar">>},
                {<<"9.7.0">>, <<"0.032">>, <<"kVA">>},
                {<<"10.7.0">>, <<"0.000">>, <<"kVA">>},
                {<<"0.0.1">>, <<"  1ELS0012345678">>, undefined},
                {<<"0.9.1">>, <<"063058">>, undefined},
                {<<"0.9.2">>, <<"240904">>, undefined},
                {<<"2.8.0">>, <<"0017422.710">>, <<"kWh">>}
            ]},
            <<>>},
    Result1 = erl62056_parser:decode(Data1),
    ?assertEqual(Expect1, Result1).
